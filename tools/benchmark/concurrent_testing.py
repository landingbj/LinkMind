import json
import time
import random
import uuid
import requests
from concurrent.futures import ThreadPoolExecutor, as_completed
from requests.exceptions import RequestException, HTTPError, ConnectionError, Timeout

# 请求地址
COMPLETIONS_URL = 'http://127.0.0.1:8080/chat/completions'

# 测试问题数组
questions = [
    "地球的大气层主要由哪些气体组成？",
    "光合作用的主要产物是什么？",
    "中国的长城始建于哪个朝代？",
    "计算机的CPU全称是什么？",
    "太阳系中最大的行星是哪颗？",
    "人体最大的器官是什么？",
    "二战结束于哪一年？",
    "Python是一种什么类型的编程语言？",
    "世界上最长的河流是哪条？",
    "DNA的全称是什么？",
    "火山喷发的主要原因是啥？",
    "莎士比亚的四大悲剧有哪些？",
    "元素周期表中的第一个元素是什么？",
    "南极洲的最大冰川是什么？",
    "互联网的起源可以追溯到哪个项目？",
    "人体有多少块骨头？",
    "金字塔主要位于哪个国家？",
    "光速的数值是多少？",
    "佛教的创始人是谁？",
    "股票市场的“道琼斯指数”指的是什么？",
    "地球的自转周期是多少小时？",
    "显微镜的主要用途是什么？",
    "文艺复兴的发源地是哪里？",
    "地球上最深的海洋是哪个？",
    "区块链技术最初应用于哪个领域？",
    "人体血液的主要成分是什么？",
    "希腊神话中的主神是谁？",
    "X射线是谁发现的？",
    "世界上最大的沙漠是哪个？",
    "量子力学的主要研究对象是什么？",
    "法国大革命发生在哪一年？",
    "TCP/IP协议的主要功能是什么？",
    "地球上最高的山峰是哪座？",
    "细胞分裂的过程叫什么？",
    "莫扎特的代表作有哪些？",
    "银河系的直径大约是多少光年？",
    "地球的赤道周长大约是多少公里？",
    "HTML的全称是什么？",
    "恐龙灭绝的主要理论是什么？",
    "联合国成立于哪一年？",
    "维生素C的主要功能是什么？",
    "罗马帝国的首都是哪里？",
    "人工智能的三大核心技术是什么？",
    "地球上最冷的地方是哪里？",
    "蛋白质的基本单位是什么？",
    "蒸汽机的发明者是谁？",
    "世界上最大的岛屿是哪个？",
    "加密货币比特币诞生于哪一年？",
    "人体的主要能量来源是什么？",
    "诺贝尔奖有多少个类别？",
    "地球的自转方向是怎样的？",
    "云计算的核心概念是什么？",
    "人体最坚硬的部位是什么？",
    "文艺复兴时期的代表画家是谁？",
    "地球上最大的哺乳动物是什么？",
    "5G网络的主要优势是什么？",
    "人体内的红细胞功能是什么？",
    "古埃及的象形文字叫什么？",
    "地球的磁场主要由什么产生？",
    "机器学习的主要类型有哪些？",
    "世界上最古老的大学是哪所？",
    "人体内的主要消化器官是什么？",
    "相对论的提出者是谁？",
    "世界上最大的珊瑚礁在哪里？",
    "大数据的“3V”特性是什么？",
    "人体内的主要排毒器官是什么？",
    "古希腊哲学家亚里士多德的学生是谁？",
    "地球的自转轴倾斜角度是多少？",
    "虚拟现实（VR）技术的主要应用领域是什么？",
    "人体内的主要免疫细胞是什么？",
    "工业革命始于哪个国家？",
    "地球上最大的火山是哪个？",
    "深度学习的核心算法是什么？",
    "人体内的主要呼吸器官是什么？",
    "古罗马的斗兽场位于哪里？",
    "地球的板块构造理论是什么？",
    "增强现实（AR）与虚拟现实（VR）的区别是什么？",
    "人体内的主要内分泌腺是什么？",
    "冷战的主要对峙双方是谁？",
    "地球上最大的洋流是什么？",
    "神经网络的基本单位是什么？",
    "人体内的主要感觉器官有哪些？",
    "文艺复兴时期的代表雕塑家是谁？",
    "地球上最干旱的地区是哪里？",
    "物联网的主要技术基础是什么？",
    "人体内的主要循环系统是什么？",
    "古希腊的帕特农神庙供奉哪位神？",
    "地球的自转对气候有何影响？",
    "量子计算的主要优势是什么？",
    "人体内的主要神经系统是什么？",
    "第一次世界大战的导火索是什么？",
    "地球上最大的湖泊是哪个？",
    "强化学习的主要应用场景是什么？",
    "人体内的主要储存能量的物质是什么？",
    "古中国的四大发明是什么？",
    "地球的臭氧层主要作用是什么？",
    "边缘计算的主要特点是什么？",
    "人体内的主要遗传物质是什么？",
    "古印度的佛教圣地菩提伽耶与谁有关？",
    "地球的温室效应主要由哪些气体引起？",
    "自然语言处理的主要任务是什么？",
    "人体内的主要运动骨骼是什么？",
    "古罗马的“十二铜表法”是什么？",
    "地球上最大的地震带是哪个？",
    "生成对抗网络（GAN）的主要用途是什么？",
    "人体内的主要激素是什么？",
    "文艺复兴时期的代表科学家是谁？",
    "地球上最大的热带雨林是哪里？",
    "联邦学习的主要优势是什么？",
    "人体内的主要抗体是什么？",
    "古希腊的奥林匹克运动会始于哪一年？",
    "地球的自转速度在赤道和极点有何不同？",
    "计算机视觉的主要任务是什么？",
    "人体内的主要代谢器官是什么？",
    "古埃及的法老图坦卡蒙属于哪个朝代？",
    "地球上最大的洋是哪个？",
    "推荐系统的核心算法是什么？",
    "人体内的主要电解质是什么？",
    "古中国的科举制度始于哪个朝代？",
    "地球的月球潮汐力对什么有影响？",
    "时间序列分析的主要应用是什么？",
    "人体内的主要脂肪组织是什么？",
    "古罗马的凯撒大帝全名是什么？",
    "地球上最大的陨石坑在哪里？",
    "迁移学习的主要用途是什么？",
    "人体内的主要免疫器官是什么？",
    "古希腊的《荷马史诗》包括哪些作品？",
    "地球的自转对洋流有何影响？",
    "自动驾驶技术的主要挑战是什么？",
    "人体内的主要神经递质是什么？",
    "古中国的《孙子兵法》作者是谁？",
    "地球上最大的高原是哪个？",
    "语音识别技术的主要流程是什么？",
    "人体内的主要水分来源是什么？",
    "古罗马的“ Pax Romana”是什么意思？",
    "地球的极光主要出现在哪里？",
    "知识图谱的主要应用场景是什么？",
    "人体内的主要能量代谢途径是什么？",
    "古希腊的三大哲学家是谁？",
    "地球上最大的峡谷是哪个？",
    "半监督学习的主要优势是什么？",
    "人体内的主要激素分泌器官是什么？",
    "古中国的《道德经》作者是谁？",
    "地球的自转对风向有何影响？",
    "数字孪生技术的主要应用是什么？",
    "人体内的主要淋巴器官是什么？",
    "古罗马的“元老院”主要职能是什么？",
    "地球上最大的冰川系统在哪里？",
    "多模态学习的主要研究方向是什么？",
    "人体内的主要微生物群在哪里？",
    "古中国的《史记》作者是谁？",
    "地球的自转对昼夜变化有何影响？",
    "隐私计算的主要技术有哪些？",
    "地震通常用哪个仪器测量？",
    "脑部的主要功能区有哪些？",
    "硬盘与内存的区别是什么？",
    "19世纪发现的‘魔鬼足迹’现象发生在哪个国家？",
    "地球上最稀有的天然放射性元素是什么？",
    "古巴比伦的‘空中花园’是否真实存在过？",
    "计算机中‘忙等待’的替代方案是什么？",
    "南极洲唯一已知的有袋类动物化石是什么？",
    "人体内的‘岛细胞’主要分泌什么物质？",
    "冷战期间的‘猪湾事件’发生在哪个国家？",
    "编程语言APL以什么独特符号系统著称？",
    "世界上最小的火山位于哪个国家？",
    "生物学中的‘隐性遗传漂变’是什么现象？",
    "中世纪欧洲的‘狼人审判’主要发生在哪个地区？",
    "量子计算中的‘布洛赫球’用来表示什么？",
    "地球上最古老的沙漠化石群位于哪里？",
    "人体内的‘帕钦尼小体’感知什么刺激？",
    "古希腊的‘赫利孔山’与哪位神祇有关？",
    "区块链中的‘拜占庭容错’解决什么问题？",
    "地球上最深的地下湖泊在哪里？",
    "人体内的‘朗格汉斯细胞’主要存在于哪里？",
    "文艺复兴时期的‘卡巴拉’学说源自哪里？",
    "计算机中的‘图灵完备’指的是什么能力？",
    "地球上唯一由陨石撞击形成的岛屿在哪里？",
    "生物学中的‘拟态环’现象如何形成？",
    "古埃及的‘赫里奥波利斯’崇拜哪位神？",
    "密码学中的‘椭圆曲线’有何独特优势？",
    "地球上最古老的活化石鱼类是什么？",
    "人体内的‘库普弗细胞’主要功能是什么？",
    "中世纪的‘圣杯骑士团’传说起源于哪里？",
    "人工智能中的‘反向传播’最早由谁提出？",
    "地球上最小的哺乳动物化石发现于哪里？",
    "生物学中的‘同源异形’现象指的是什么？",
    "古罗马的‘维斯塔贞女’有何特殊职责？",
    "计算机中的‘一致性哈希’用于什么场景？",
    "地球上最古老的珊瑚礁系统在哪里？",
    "人体内的‘梅克尔细胞’与什么功能相关？",
    "文艺复兴时期的‘炼金术符号’有何意义？",
    "量子力学中的‘贝尔不等式’验证了什么？",
    "地球上最深的天然井在哪里？",
    "生物学中的‘趋化因子’如何影响细胞？",
    "古中国的‘九章算术’解决了什么问题？",
    "计算机中的‘内存屏障’有何作用？",
    "地球上最古老的活树种是什么？",
    "人体内的‘星形胶质细胞’主要功能是什么？",
    "中世纪的‘黑死病’最早登陆欧洲的港口是哪里？",
    "区块链中的‘工作量证明’最初由谁提出？",
    "地球上最小的天然温泉在哪里？",
    "生物学中的‘表观遗传标记’如何影响基因？",
    "古希腊的‘德尔斐神谕’由谁主持？",
    "计算机中的‘零知识证明’最早应用于什么？",
    "地球上最古老的火山岩层在哪里？",
    "人体内的‘施万细胞’主要存在于哪里？",
    "文艺复兴时期的‘神秘主义数字’指的是什么？",
    "量子计算中的‘量子纠缠态’有何特性？",
    "地球上最深的地下洞穴系统在哪里？",
    "生物学中的‘基因剪接’最早发现于什么物种？",
    "古罗马的‘阿皮亚大道’通往哪里？",
    "计算机中的‘分布式锁’如何实现？",
    "地球上最古老的化石森林在哪里？",
    "人体内的‘嗜碱性粒细胞’主要功能是什么？",
    "中世纪的‘炼金术士帕拉塞尔苏斯’提出了什么理论？",
    "区块链中的‘智能合约’最早由谁定义？",
    "地球上最小的天然瀑布在哪里？",
    "生物学中的‘线粒体夏娃’理论指的是什么？",
    "古埃及的‘阿蒙神’象征什么？",
    "计算机中的‘协程’与线程的区别是什么？",
    "地球上最古老的陨石碎片发现于哪里？",
    "人体内的‘内皮细胞’在血管中的作用是什么？",
    "文艺复兴时期的‘星盘’主要用于什么？",
    "量子力学中的‘海森堡不确定性原理’如何影响测量？",
    "地球上最深的天然裂缝在哪里？",
    "生物学中的‘异染色质’与基因表达的关系是什么？",
    "古中国的‘黄帝内经’最早记载了什么医学理论？",
    "计算机中的‘缓存一致性协议’解决了什么问题？",
    "地球上最古老的活珊瑚是什么？",
    "人体内的‘巨噬细胞’如何识别病原体？",
    "中世纪的‘圣殿骑士团’解散的原因是什么？",
    "区块链中的‘分片技术’如何提高性能？",
    "地球上最小的天然湖泊在哪里？",
    "生物学中的‘RNA干扰’机制如何工作？",
    "古希腊的‘伊卡洛斯’神话象征什么？",
    "计算机中的‘虚拟内存’最早由谁提出？",
    "地球上最古老的地下水系在哪里？",
    "人体内的‘树突细胞’在免疫中的作用是什么？",
    "文艺复兴时期的‘人文主义’核心思想是什么？",
    "量子计算中的‘量子门’如何操作？",
    "地球上最深的火山口湖在哪里？",
    "生物学中的‘表型可塑性’指的是什么？",
    "古罗马的‘卡拉卡拉浴场’有何独特设计？",
    "计算机中的‘事件驱动模型’适用于什么场景？",
    "地球上最古老的化石细菌发现于哪里？",
    "人体内的‘肥大细胞’与什么反应有关？",
    "中世纪的‘玫瑰战争’发生在哪个国家？",
    "区块链中的‘去中心化自治组织’如何运作？",
    "地球上最小的天然岛屿在哪里？",
    "生物学中的‘基因组印迹’如何影响遗传？",
    "古埃及的‘荷鲁斯之眼’象征什么？",
    "计算机中的‘内存池’技术如何优化性能？",
    "地球上最古老的活化石昆虫是什么？",
    "人体内的‘神经胶质细胞’与神经元的关系是什么？",
    "文艺复兴时期的‘比例尺规’由谁发明？",
    "量子力学中的‘波粒二象性’最早由谁提出？",
    "地球上最深的地下矿井在哪里？",
    "生物学中的‘转录因子’如何调控基因？",
    "古中国的‘墨家’学派主张什么思想？",
    "计算机中的‘垃圾回收’机制最早出现在哪种语言？",
    "地球上最古老的化石足迹发现于哪里？",
    "人体内的‘嗜酸性粒细胞’主要对抗什么？",
    "中世纪的‘十字军东征’首次由谁发起？",
    "区块链中的‘共识算法’有哪些种类？",
    "地球上最小的天然洞穴在哪里？",
    "生物学中的‘染色质重塑’如何影响基因表达？",
    "古希腊的‘俄耳甫斯教’崇拜什么？",
    "计算机中的‘并发控制’解决了什么问题？",
    "地球上最古老的活化石植物是什么？",
    "人体内的‘平滑肌细胞’主要存在于哪里？",
    "文艺复兴时期的‘透视法’由谁系统化？",
    "量子计算中的‘量子退火’适用于什么问题？",
    "地球上最深的天然隧道在哪里？",
    "生物学中的‘基因编辑’技术CRISPR最早发现于什么？",
    "古罗马的‘庞贝古城’被哪座火山摧毁？",
    "计算机中的‘管道模型’如何提高效率？",
    "地球上最古老的化石藻类发现于哪里？",
    "人体内的‘成骨细胞’主要功能是什么？",
    "中世纪的‘炼金术符号’中的‘哲人之石’象征什么？",
    "区块链中的‘侧链’技术有何用途？",
    "地球上最小的天然火山口在哪里？",
    "生物学中的‘端粒酶’与什么过程有关？",
    "古埃及的‘死亡之书’主要记录了什么？",
    "计算机中的‘中断向量表’有何作用？",
    "地球上最古老的活化石爬行动物是什么？",
    "人体内的‘破骨细胞’如何影响骨骼？",
    "文艺复兴时期的‘星图’由谁首次绘制？",
    "量子力学中的‘薛定谔方程’描述了什么？",
    "地球上最深的天然温泉在哪里？",
    "生物学中的‘基因沉默’机制如何实现？",
    "古中国的‘天皇氏’神话与什么有关？",
    "计算机中的‘线程池’如何优化资源？",
    "地球上最古老的化石鸟类发现于哪里？",
    "人体内的‘角质细胞’主要存在于哪里？",
    "中世纪的‘抄本装饰艺术’盛行于哪个地区？",
    "区块链中的‘闪电网络’解决了什么问题？",
    "地球上最小的天然陨石坑在哪里？",
    "生物学中的‘自噬作用’如何维持细胞健康？",
    "古希腊的‘皮提亚’与什么神谕有关？",
    "计算机中的‘影子分页’技术用于什么？"
]

# 设置
RANDOM_TEST = True
MAX_THREADS = 25  # 每批最大并发数
FETCH_TIMES = 5   # 抓取次数
API_KEY = ''
MODEL = None

def process():
    print(f"\n 总问题池大小：{len(questions)}，抓取次数：{FETCH_TIMES}，每次抓取数量：{MAX_THREADS}")
    for i in range(FETCH_TIMES):
        print(f"\n 第 {i + 1} 次抓取测试开始...")
        sample_questions = random.choices(questions, k=MAX_THREADS)
        test(sample_questions)

def test(questions_batch):
    total_count = len(questions_batch)
    total_tokens = 0
    total_duration = 0

    futures = []
    with ThreadPoolExecutor(max_workers=MAX_THREADS) as executor:
        for q in questions_batch:
            prompt = random.choice(questions) if RANDOM_TEST else q
            qid = uuid.uuid4().hex[:6]  # 简短唯一 ID
            print(f"\n======== [QID: {qid}] 请求问题：{prompt}")
            futures.append(executor.submit(completions, COMPLETIONS_URL, API_KEY, MODEL, prompt, qid))

        for future in as_completed(futures):
            try:
                prompt, answer, duration, tokens, qid = future.result()
                total_tokens += tokens
                total_duration += duration
            except Exception as e:
                print(f"[QID: {qid}] 线程执行错误：{repr(e)}")
                import traceback
                print(f"[QID: {qid}] 完整堆栈跟踪：\n{traceback.format_exc()}")

    if total_duration > 0:
        avg_speed = total_tokens / total_duration
        avg_duration = total_duration / total_count
        print(f"\n======== 平均每秒 token 数：{avg_speed:.3f} ========")
        print(f"======== 平均每个请求耗时：{avg_duration:.3f} 秒 ========")

def completions(url, api_key, model, prompt, qid):
    headers = {
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {api_key}'
    }

    data = {
        "category": "lagi",
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.8,
        "max_tokens": 1024,
        "stream": False
    }

    if model:
        data["model"] = model

    start_time = time.time()
    completion_tokens = 0
    answer = ''

    try:
        print(f"[QID: {qid}] 请求体: {json.dumps(data, ensure_ascii=False)}")
        response = requests.post(url, data=json.dumps(data), headers=headers, timeout=600)
        print(f"[QID: {qid}] 响应状态码: {response.status_code}")
        print(f"[QID: {qid}] 原始响应全文: {response.text}")

        if response.status_code == 200:
            try:
                result = json.loads(response.text)
                print(f"\n[QID: {qid}] 请求结果：\n{json.dumps(result, indent=2, ensure_ascii=False)}")
                if result.get("usage"):
                    completion_tokens = result["usage"].get("completion_tokens", 0)
                answer = result
            except json.JSONDecodeError as json_err:
                print(f"[QID: {qid}] JSON解析失败: {repr(json_err)}")
                print(f"[QID: {qid}] 完整堆栈跟踪：\n{traceback.format_exc()}")
                raise
        else:
            response.raise_for_status()
    except (HTTPError, ConnectionError, Timeout, RequestException) as e:
        print(f"[QID: {qid}] 请求异常: {repr(e)}")
        import traceback
        print(f"[QID: {qid}] 完整堆栈跟踪：\n{traceback.format_exc()}")
        raise
    except Exception as e:
        print(f"[QID: {qid}] 未知异常: {repr(e)}")
        import traceback
        print(f"[QID: {qid}] 完整堆栈跟踪：\n{traceback.format_exc()}")
        raise

    duration = time.time() - start_time
    print(f"\n[QID: {qid}] 总耗时: {duration:.3f} 秒")
    if completion_tokens > 0:
        print(f"[QID: {qid}] 请求速度: {completion_tokens / duration:.2f} tokens/秒")

    return prompt, answer, duration, completion_tokens, qid

if __name__ == "__main__":
    process()
